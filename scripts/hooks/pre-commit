#!/bin/bash
# Pre-commit hook: Run Maestro smoke test before commits
# Install: ./scripts/setup-hooks.sh

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if maestro is installed
if ! command -v maestro &> /dev/null; then
    echo -e "${YELLOW}Warning: Maestro not installed. Skipping E2E smoke test.${NC}"
    echo "Install with: curl -Ls 'https://get.maestro.mobile.dev' | bash"
    exit 0
fi

# Check if a device/emulator is available
check_device() {
    # TODO: Implement device detection logic
    # Return 0 if device available, 1 if not
    return 1
}

if ! check_device; then
    echo -e "${YELLOW}No device/emulator detected. Skipping Maestro smoke test.${NC}"
    echo "Start an emulator or connect a device to enable E2E testing."
    exit 0
fi

echo -e "${GREEN}Running Maestro smoke test...${NC}"

# Run smoke test with 60s timeout
if timeout 60 maestro test maestro/flows/00_smoke_test.yaml --no-ansi 2>/dev/null; then
    echo -e "${GREEN}Smoke test passed.${NC}"
else
    echo -e "${RED}Smoke test failed. Commit blocked.${NC}"
    echo "Run 'maestro test maestro/flows/00_smoke_test.yaml' to debug."
    exit 1
fi
